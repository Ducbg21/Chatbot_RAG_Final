{% extends "HaOai_ChatBot/base.html" %}
{% load static %}

{% block breadcrumb %}
<ul class="breadcrumb fw-semibold fs-base my-1">
    <li class="breadcrumb-item text-muted">
        <a href="{% static 'HaOai_Chatbot/../dist/index.html' %}" class="text-muted">Home</a>
    </li>
    <li class="breadcrumb-item text-dark">Chat</li>
</ul>
{% endblock breadcrumb %}

{% block nav %}
<!--begin::Nav-->
<div class="aside-nav d-flex flex-column flex-lg-center flex-column-fluid w-100 py-5 px-3" id="kt_aside_nav">
    <!--begin::Aside Primary Menu Wrapper-->
    <div class="w-100 hover-scroll-overlay-y d-flex" id="kt_aside_menu_wrapper" data-kt-scroll="true" data-kt-scroll-height="auto" data-kt-scroll-dependencies="#kt_aside_logo, #kt_aside_footer" data-kt-scroll-wrappers="#kt_aside, #kt_aside_nav, #kt_aside_menu_wrapper" data-kt-scroll-offset="5px">
        <!--begin::Primary menu-->
        <div id="kt_aside_menu" class="menu menu-rounded menu-column menu-active-bg menu-title-gray-600 menu-icon-gray-400 menu-state-primary menu-arrow-gray-500 fw-semibold fs-6 my-auto" data-kt-menu="true">
            <!--begin:Menu item-->
            <div data-kt-menu-trigger="{default: 'click', lg: 'hover'}" data-kt-menu-placement="right-start" class="menu-item py-2">
                <!--begin:Menu link-->
                <span class="menu-link menu-center">
                    <span class="menu-icon me-0">
                        <!--begin::Svg Icon | path: icons/duotune/general/gen025.svg-->
                        <span class="svg-icon svg-icon-2x">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="2" y="2" width="9" height="9" rx="2" fill="currentColor" />
                                <rect opacity="0.3" x="13" y="2" width="9" height="9" rx="2" fill="currentColor" />
                                <rect opacity="0.3" x="13" y="13" width="9" height="9" rx="2" fill="currentColor" />
                                <rect opacity="0.3" x="2" y="13" width="9" height="9" rx="2" fill="currentColor" />
                            </svg>
                        </span>
                        <!--end::Svg Icon-->
                    </span>
                </span>
                <!--end:Menu link-->
                <!--begin:Menu sub-->
                <div class="menu-sub menu-sub-indention menu-sub-dropdown w-225px px-2 py-4">
                    <!--begin:Menu item-->
                    <div class="menu-item">
                        <!--begin:Menu link-->
                        <a class="menu-link active" href="{% url 'workspace:workspace_view' %}">
                            <span class="menu-bullet">
                                <span class="bullet bullet-dot"></span>
                            </span>
                            <span class="menu-title">Dashboard</span>
                        </a>
                        <!--end:Menu link-->
                    </div>
                    <!--end:Menu item-->
<!--											&lt;!&ndash;begin:Menu item&ndash;&gt;-->
<!--											<div class="menu-item">-->
<!--												&lt;!&ndash;begin:Menu link&ndash;&gt;-->
<!--												<a class="menu-link" href="../dist/dashboards/projects.html">-->
<!--													<span class="menu-bullet">-->
<!--														<span class="bullet bullet-dot"></span>-->
<!--													</span>-->
<!--													<span class="menu-title">Projects</span>-->
<!--												</a>-->
<!--												&lt;!&ndash;end:Menu link&ndash;&gt;-->
<!--											</div>-->
<!--											&lt;!&ndash;end:Menu item&ndash;&gt;-->
<!--											&lt;!&ndash;begin:Menu item&ndash;&gt;-->
<!--											<div class="menu-item">-->
<!--												&lt;!&ndash;begin:Menu link&ndash;&gt;-->
<!--												<a class="menu-link" href="../dist/dashboards/logistics.html">-->
<!--													<span class="menu-bullet">-->
<!--														<span class="bullet bullet-dot"></span>-->
<!--													</span>-->
<!--													<span class="menu-title">Logistics</span>-->
<!--												</a>-->
<!--												&lt;!&ndash;end:Menu link&ndash;&gt;-->
<!--											</div>-->
<!--											&lt;!&ndash;end:Menu item&ndash;&gt;-->
<!--											&lt;!&ndash;begin:Menu item&ndash;&gt;-->
<!--											<div class="menu-item">-->
<!--												&lt;!&ndash;begin:Menu link&ndash;&gt;-->
<!--												<a class="menu-link" href="../dist/dashboards/store-analytics.html">-->
<!--													<span class="menu-bullet">-->
<!--														<span class="bullet bullet-dot"></span>-->
<!--													</span>-->
<!--													<span class="menu-title">Store Analytics</span>-->
<!--												</a>-->
<!--												&lt;!&ndash;end:Menu link&ndash;&gt;-->
<!--											</div>-->
<!--											&lt;!&ndash;end:Menu item&ndash;&gt;-->
<!--											&lt;!&ndash;begin:Menu item&ndash;&gt;-->
<!--											<div class="menu-item">-->
<!--												&lt;!&ndash;begin:Menu link&ndash;&gt;-->
<!--												<a class="menu-link" href="../dist/dashboards/finance-performance.html">-->
<!--													<span class="menu-bullet">-->
<!--														<span class="bullet bullet-dot"></span>-->
<!--													</span>-->
<!--													<span class="menu-title">Finance Performance</span>-->
<!--												</a>-->
<!--												&lt;!&ndash;end:Menu link&ndash;&gt;-->
<!--											</div>-->
<!--											&lt;!&ndash;end:Menu item&ndash;&gt;-->
                </div>
                <!--end:Menu sub-->
            </div>
            <!--end:Menu item-->
            <!--begin:Menu item-->
            <div data-kt-menu-trigger="{default: 'click', lg: 'hover'}" data-kt-menu-placement="right-start" class="menu-item py-2">
                <!--begin:Menu link-->
                <span class="menu-link menu-center">
                    <span class="menu-icon me-0">
                        <!--begin::Svg Icon | path: Document icon-->
                        <span class="svg-icon svg-icon-2x">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path opacity="0.3" d="M19 22H5C4.4 22 4 21.6 4 21V3C4 2.4 4.4 2 5 2H14L20 8V21C20 21.6 19.6 22 19 22Z" fill="currentColor" />
                                <path d="M15 8H20L14 2V7C14 7.6 14.4 8 15 8Z" fill="currentColor" />
                                <rect x="7.5" y="12" width="9" height="1" rx="0.5" fill="currentColor" />
                                <rect x="7.5" y="15" width="9" height="1" rx="0.5" fill="currentColor" />
                            </svg>
                        </span>
                        <!--end::Svg Icon-->
                    </span>
                </span>
                <!--end:Menu link-->
                <!--begin:Menu sub-->
                <div class="menu-sub menu-sub-dropdown w-225px px-2 py-4">
                    <!--begin:Menu item-->
                    <div class="menu-item">
                        <!--begin:Menu content-->
                        <div class="menu-content">
                            <span class="menu-section fs-5 fw-bold ps-1 py-1">Document Management</span>
                        </div>
                        <!--end:Menu content-->
                    </div>
                    <!--end:Menu item-->

                    <!--begin:Menu item-->
                    <div class="menu-item">
                        <!--begin:Menu link-->
                        <a class="menu-link" href="{% url 'document:document_view' %}">
                            <span class="menu-bullet">
                                <span class="bullet bullet-dot"></span>
                            </span>
                            <span class="menu-title">List View</span>
                        </a>
                        <!--end:Menu link-->
                    </div>
                    <!--end:Menu item-->

<!--											&lt;!&ndash;begin:Menu item&ndash;&gt;-->
<!--											<div class="menu-item">-->
<!--												&lt;!&ndash;begin:Menu link&ndash;&gt;-->
<!--												<a class="menu-link" href="../dist/documents/grid-view.html">-->
<!--													<span class="menu-bullet">-->
<!--														<span class="bullet bullet-dot"></span>-->
<!--													</span>-->
<!--													<span class="menu-title">Grid View</span>-->
<!--												</a>-->
<!--												&lt;!&ndash;end:Menu link&ndash;&gt;-->
<!--											</div>-->
<!--											&lt;!&ndash;end:Menu item&ndash;&gt;-->

                    <!--begin:Menu item-->
                    <div class="menu-item">
                        <!--begin:Menu link-->
                        <a class="menu-link" href="{% url 'document:upload_document_view' %}">
                            <span class="menu-bullet">
                                <span class="bullet bullet-dot"></span>
                            </span>
                            <span class="menu-title">Upload Document</span>
                        </a>
                        <!--end:Menu link-->
                    </div>
                    <!--end:Menu item-->

<!--											&lt;!&ndash;begin:Menu item&ndash;&gt;-->
<!--											<div class="menu-item">-->
<!--												&lt;!&ndash;begin:Menu link&ndash;&gt;-->
<!--												<a class="menu-link" href="../dist/documents/categories.html">-->
<!--													<span class="menu-bullet">-->
<!--														<span class="bullet bullet-dot"></span>-->
<!--													</span>-->
<!--													<span class="menu-title">Categories</span>-->
<!--												</a>-->
<!--												&lt;!&ndash;end:Menu link&ndash;&gt;-->
<!--											</div>-->
<!--											&lt;!&ndash;end:Menu item&ndash;&gt;-->

<!--											&lt;!&ndash;begin:Menu item&ndash;&gt;-->
<!--											<div class="menu-item">-->
<!--												&lt;!&ndash;begin:Menu link&ndash;&gt;-->
<!--												<a class="menu-link" href="../dist/documents/archive.html">-->
<!--													<span class="menu-bullet">-->
<!--														<span class="bullet bullet-dot"></span>-->
<!--													</span>-->
<!--													<span class="menu-title">Archive</span>-->
<!--												</a>-->
<!--												&lt;!&ndash;end:Menu link&ndash;&gt;-->
<!--											</div>-->
<!--											&lt;!&ndash;end:Menu item&ndash;&gt;-->

<!--											&lt;!&ndash;begin:Menu item&ndash;&gt;-->
<!--											<div class="menu-item">-->
<!--												&lt;!&ndash;begin:Menu link&ndash;&gt;-->
<!--												<a class="menu-link" href="../dist/documents/permissions.html">-->
<!--													<span class="menu-bullet">-->
<!--														<span class="bullet bullet-dot"></span>-->
<!--													</span>-->
<!--													<span class="menu-title">Permissions</span>-->
<!--												</a>-->
<!--												&lt;!&ndash;end:Menu link&ndash;&gt;-->
<!--											</div>-->
<!--											&lt;!&ndash;end:Menu item&ndash;&gt;-->

<!--											&lt;!&ndash;begin:Menu item&ndash;&gt;-->
<!--											<div class="menu-item">-->
<!--												&lt;!&ndash;begin:Menu link&ndash;&gt;-->
<!--												<a class="menu-link" href="../dist/documents/version-history.html">-->
<!--													<span class="menu-bullet">-->
<!--														<span class="bullet bullet-dot"></span>-->
<!--													</span>-->
<!--													<span class="menu-title">Version History</span>-->
<!--												</a>-->
<!--												&lt;!&ndash;end:Menu link&ndash;&gt;-->
<!--											</div>-->
<!--											&lt;!&ndash;end:Menu item&ndash;&gt;-->
                </div>
                <!--end:Menu sub-->
            </div>
            <!--begin:Menu item-->
            <div data-kt-menu-trigger="{default: 'click', lg: 'hover'}" data-kt-menu-placement="right-start" class="menu-item py-2">
                <!--begin:Menu link-->
                <span class="menu-link menu-center">
                    <span class="menu-icon me-0">
                        <!--begin::Svg Icon | path: icons/duotune/communication/com013.svg-->
                        <span class="svg-icon svg-icon-2x">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6.28548 15.0861C7.34369 13.1814 9.35142 12 11.5304 12H12.4696C14.6486 12 16.6563 13.1814 17.7145 15.0861L19.3493 18.0287C20.0899 19.3618 19.1259 21 17.601 21H6.39903C4.87406 21 3.91012 19.3618 4.65071 18.0287L6.28548 15.0861Z" fill="currentColor" />
                                <rect opacity="0.3" x="8" y="3" width="8" height="8" rx="4" fill="currentColor" />
                            </svg>
                        </span>
                        <!--end::Svg Icon-->
                    </span>
                </span>
                <!--end:Menu link-->
                <!--begin:Menu sub-->
                <div class="menu-sub menu-sub-indention menu-sub-dropdown w-225px px-2 py-4">
                    <!--begin:Menu item-->
                    <div class="menu-item">
                        <!--begin:Menu content-->
                        <div class="menu-content">
                            <span class="menu-section fs-5 fw-bold ps-1 py-1">Account</span>
                        </div>
                        <!--end:Menu content-->
                    </div>
                    <!--end:Menu item-->
                    <!--begin:Menu item-->
                    <div class="menu-item">
                        <!--begin:Menu link-->
                        <a class="menu-link" href="{% url 'account:my_profile_view' %}">
                            <span class="menu-bullet">
                                <span class="bullet bullet-dot"></span>
                            </span>
                            <span class="menu-title">Overview</span>
                        </a>
                        <!--end:Menu link-->
                    </div>
                    <!--end:Menu item-->
                    <!--begin:Menu item-->
                    <div class="menu-item">
                        <!--begin:Menu link-->
                        <a class="menu-link" href="{% url 'account:user_settings_view' %}">
                            <span class="menu-bullet">
                                <span class="bullet bullet-dot"></span>
                            </span>
                            <span class="menu-title">Settings</span>
                        </a>
                        <!--end:Menu link-->
                    </div>
                    <!--end:Menu item-->

                    <!--begin:Menu item-->
                    <div class="menu-item">
                        <!--begin:Menu link-->
                        <a class="menu-link" href="{% url 'account:user_settings_view' %}">
                            <span class="menu-bullet">
                                <span class="bullet bullet-dot"></span>
                            </span>
                            <span class="menu-title">Activity</span>
                        </a>
                        <!--end:Menu link-->
                    </div>
                    <!--end:Menu item-->

                </div>
                <!--end:Menu sub-->
            </div>
            <!--end:Menu item-->

            <!--begin:Chatbot Menu Item-->
            <div class="menu-item here show py-2">
                <!--begin:Menu link-->
                <a href="{% url 'chatbot:chat_view' %}" class="menu-link menu-center">
                    <span class="menu-icon me-0">
                        <!--begin::Svg Icon: Chatbot icon (you can change SVG if needed)-->
                        <span class="svg-icon svg-icon-2x">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.03 2 11c0 2.21.89 4.21 2.34 5.76L4 22l5.02-1.67c.95.26 1.96.4 2.98.4 5.52 0 10-4.03 10-9s-4.48-9-10-9zm0 16c-.87 0-1.71-.13-2.5-.37l-.36-.11-2.65.88.9-2.62-.27-.33C6.35 14.07 6 12.9 6 11.5 6 7.91 8.69 5 12 5s6 2.91 6 6.5-2.69 6.5-6 6.5z"/>
                            </svg>
                        </span>
                        <!--end::Svg Icon-->
                    </span>
                </a>
                <!--end:Menu link-->
            </div>
            <!--end:Chatbot Menu Item-->


        </div>
        <!--end::Primary menu-->
    </div>
    <!--ebd::Aside Primary Menu Wrapper-->
</div>
<!--end::Nav-->
{% endblock %}

{% block content %}
<div class="container-xxl" id="kt_content_container">
        <div class="d-flex flex-column flex-lg-row justify-content-center align-items-center">
            <div class="flex-lg-row-fluid w-100" style="max-width:900px;">
                <div class="card" id="kt_chat_messenger">
                    <div class="card-header" id="kt_chat_messenger_header">
                        <div class="card-title">
                            <div class="d-flex justify-content-center flex-column me-3">
                                <span class="fs-4 fw-bold text-gray-900 me-1 mb-2 lh-1">Chatbot</span>
                                <div class="mb-0 lh-1">
                                    <span class="badge badge-success badge-circle w-10px h-10px me-1"></span>
                                    <span class="fs-7 fw-semibold text-muted">Online</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="kt_chat_messenger_body">
                        <div id="chat-messages" class="scroll-y pe-3" style="height: 700px; overflow-y: auto; padding-right: 10px;">
                            <!-- Tin nhắn sẽ được thêm vào đây bằng JS -->
                        </div>
                    </div>
                    <div class="card-footer pt-4" id="kt_chat_messenger_footer">
                        <textarea id="chat-input" class="form-control form-control-flush mb-3" rows="1" placeholder="Type a message..."></textarea>
                        <div class="d-flex flex-stack">
                            <div></div>
                            <button class="btn btn-primary" id="send-btn" type="button">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const sendBtn = document.getElementById("send-btn");
    const chatInput = document.getElementById("chat-input");
    const chatMessages = document.getElementById("chat-messages");

    // Thêm tin nhắn vào giao diện
    function appendMessage(content, sender = "user") {
        const messageElement = document.createElement("div");
        messageElement.classList.add("d-flex", "mb-3", sender === "user" ? "justify-content-end" : "justify-content-start");
        messageElement.classList.add("message-item");

        const bubble = document.createElement("div");
<!--        bubble.classList.add("p-3", "rounded", sender === "user" ? "bg-primary text-white" : "bg-light text-dark");-->
        bubble.classList.add("p-3", "rounded");
        if (sender === "user") {
            bubble.classList.add("bg-primary", "text-white");
        } else {
            bubble.classList.add("bg-light", "text-dark");
        }

        // Thêm hiệu ứng cho tin nhắn
        bubble.style.maxWidth = "75%";
        bubble.innerText = content;

        // Thêm hoạt ảnh cho tin nhắn khi gửi
        bubble.classList.add('message-bubble-animation');

        messageElement.appendChild(bubble);
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Thêm phần tử cho tin nhắn stream
    function appendBotStreamContainer() {
        const wrapper = document.createElement("div");
        wrapper.classList.add("d-flex", "mb-3", "justify-content-start");

        const bubble = document.createElement("div");
        bubble.classList.add("p-3", "rounded", "bg-light", "text-dark");
        bubble.style.maxWidth = "75%";
        bubble.innerText = "";
        bubble.id = "bot-stream";

        wrapper.appendChild(bubble);
        chatMessages.appendChild(wrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return bubble;
    }

    // Xử lý khi gửi tin nhắn
    sendBtn.addEventListener("click", async function () {
        const question = chatInput.value.trim();
        if (!question) return;

        // Hiển thị câu hỏi của người dùng
        appendMessage(question, "user");
        chatInput.value = "";

        try {
            const response = await fetch("/chatbot/api/v1/qa_chatbot", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({ question })
            });

            if (!response.ok) {
                const errorData = await response.json();
                appendMessage("Lỗi: " + (errorData.error || "Không thể lấy phản hồi"), "bot");
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            const botBubble = appendBotStreamContainer();

            let { value, done } = await reader.read();
            while (!done) {
                const chunk = decoder.decode(value, { stream: true });
                botBubble.innerText += chunk;  // Thêm dữ liệu trả về vào tin nhắn
                chatMessages.scrollTop = chatMessages.scrollHeight;
                ({ value, done } = await reader.read());
            }
        } catch (err) {
            console.error("Error:", err);
            appendMessage("Lỗi kết nối đến server", "bot");
        }
    });

    function getCSRFToken() {
        const cookieValue = document.cookie
            .split("; ")
            .find(row => row.startsWith("csrftoken="));
        return cookieValue ? cookieValue.split("=")[1] : "";
    }
});
</script>
{% endblock %}
